package EV::MariaDB;
use strict;
use warnings;

use EV;

BEGIN {
    our $VERSION = '0.01_01';
    use XSLoader;
    XSLoader::load __PACKAGE__, $VERSION;
}

*q          = \&query;
*prep       = \&prepare;
*reconnect  = \&reset;
*disconnect = \&finish;
*errstr     = \&error_message;
*errno      = \&error_number;

my @OPTION_KEYS = qw(
    connect_timeout read_timeout write_timeout
    compress multi_statements charset init_command
    ssl_key ssl_cert ssl_ca ssl_cipher ssl_verify_server_cert
);

sub new {
    my ($class, %args) = @_;

    my $loop = delete $args{loop} || EV::default_loop;
    my $self = $class->_new($loop);

    $self->on_error(delete $args{on_error} || sub { die @_ });
    $self->on_connect(delete $args{on_connect}) if $args{on_connect};

    # set connection options before connect
    for my $key (@OPTION_KEYS) {
        if (defined(my $val = delete $args{$key})) {
            $self->_set_option($key, $val);
        }
    }

    my $host     = delete $args{host};
    my $user     = delete $args{user};
    my $password = delete $args{password};
    my $database = delete $args{database} // delete $args{db};
    my $port     = delete $args{port} // 3306;
    my $socket   = delete $args{unix_socket};

    if (defined $host || defined $user) {
        $self->connect(
            $host     // 'localhost',
            $user     // '',
            $password // '',
            $database // '',
            $port,
            $socket,
        );
    }

    $self;
}

1;

__END__

=head1 NAME

EV::MariaDB - Async MariaDB/MySQL client using libmariadb and EV

=head1 SYNOPSIS

    use EV;
    use EV::MariaDB;

    my $m = EV::MariaDB->new(
        host       => 'localhost',
        user       => 'root',
        password   => '',
        database   => 'test',
        on_connect => sub { print "connected\n" },
        on_error   => sub { warn "error: $_[0]\n" },
    );

    # simple query
    $m->query("select * from users", sub {
        my ($rows, $err) = @_;
        if ($err) { warn $err; return }
        for my $row (@$rows) {
            print join(", ", @$row), "\n";
        }
    });

    # prepared statement
    $m->prepare("select * from users where id = ?", sub {
        my ($stmt, $err) = @_;
        die $err if $err;
        $m->execute($stmt, [42], sub {
            my ($rows, $err) = @_;
            # ...
            $m->close_stmt($stmt, sub { });
        });
    });

    # pipelined queries (all sent before reading results)
    for my $id (1..100) {
        $m->q("select * from t where id = $id", sub {
            my ($rows, $err) = @_;
            # callbacks fire in order
        });
    }

    EV::run;

=head1 DESCRIPTION

EV::MariaDB is an asynchronous MariaDB/MySQL client that integrates with
the EV event loop. It uses the MariaDB Connector/C non-blocking API to
perform all database operations without blocking the event loop.

Key features:

=over 4

=item * Fully asynchronous connect, query, and prepared statement execution

=item * Query pipelining via C<mysql_send_query>/C<mysql_read_query_result>
for high throughput

=item * Prepared statements with automatic buffer management

=item * Connection utility operations (ping, reset, change_user, select_db)

=item * Multi-result set support for multi-statement queries

=back

=head1 CONSTRUCTOR

=head2 new

    my $m = EV::MariaDB->new(%args);

Creates a new EV::MariaDB object. If C<host> or C<user> is provided,
connects immediately (asynchronously).

B<Connection parameters:>

=over 4

=item host => $hostname

Server hostname. Default: C<localhost>.

=item port => $port

Server port. Default: C<3306>.

=item user => $username

Username for authentication.

=item password => $password

Password for authentication.

=item database => $dbname

Default database. Also accepts C<db> as an alias.

=item unix_socket => $path

Path to Unix domain socket.

=back

B<Callbacks:>

=over 4

=item on_connect => sub { }

Called when the connection is established. No arguments.

=item on_error => sub { my ($message) = @_ }

Called on connection-level errors. Default: C<sub { die @_ }>.

=back

B<Connection options:>

=over 4

=item connect_timeout => $seconds

=item read_timeout => $seconds

=item write_timeout => $seconds

=item compress => 1

Enable protocol compression.

=item multi_statements => 1

Allow multiple SQL statements per query string.

=item charset => $name

Character set name (e.g., C<utf8mb4>).

=item init_command => $sql

SQL statement executed automatically after connecting.

=item ssl_key => $path

=item ssl_cert => $path

=item ssl_ca => $path

=item ssl_cipher => $list

=item ssl_verify_server_cert => 1

SSL/TLS connection options.

=back

B<Event loop:>

=over 4

=item loop => $ev_loop

EV loop to use. Default: C<EV::default_loop>.

=back

=head1 METHODS

All asynchronous methods take a callback as the last argument. The
callback convention is C<($result, $error)>: on success C<$error> is
C<undef>; on failure C<$result> is C<undef> and C<$error> contains the
error message.

=head2 connect

    $m->connect($host, $user, $password, $database, $port, $unix_socket);

Connects to the server. Called automatically by C<new> when C<host> or
C<user> is provided. Use this for deferred connection:

    my $m = EV::MariaDB->new(
        on_connect => sub { ... },
        on_error   => sub { ... },
    );
    $m->connect('localhost', 'root', '', 'test', 3306);

Dies if already connected. C<$port> defaults to 3306. C<$unix_socket>
is optional (pass C<undef> or omit).

=head2 query

    $m->query($sql, sub { my ($result, $err) = @_ });

Executes a SQL query. The callback receives:

=over 4

=item * For select: C<($arrayref_of_arrayrefs, undef)>

=item * For DML (insert/update/delete): C<($affected_rows, undef)>

=item * On error: C<(undef, $error_message)>

=back

Queries are pipelined: multiple calls to C<query> before the event loop
runs will be sent as a batch, with results read back in order.

=head2 prepare

    $m->prepare($sql, sub { my ($stmt, $err) = @_ });

Prepares a server-side statement. The callback receives an opaque
statement handle or an error. Pass the handle to C<execute>,
C<close_stmt>, and C<stmt_reset>.

=head2 execute

    $m->execute($stmt, \@params, sub { my ($result, $err) = @_ });

Executes a prepared statement with the given parameters. All parameters
are bound as strings; pass C<undef> for null. The callback receives
results in the same format as C<query>.

=head2 close_stmt

    $m->close_stmt($stmt, sub { my ($ok, $err) = @_ });

Closes a prepared statement, freeing server resources.

=head2 stmt_reset

    $m->stmt_reset($stmt, sub { my ($ok, $err) = @_ });

Resets a prepared statement (clears errors and unbinds parameters)
without closing it.

=head2 ping

    $m->ping(sub { my ($ok, $err) = @_ });

Checks if the connection is alive.

=head2 select_db

    $m->select_db($dbname, sub { my ($ok, $err) = @_ });

Changes the default database.

=head2 change_user

    $m->change_user($user, $password, $db_or_undef, sub { my ($ok, $err) = @_ });

Changes the user and optionally the database. Pass C<undef> for C<$db>
to keep the current database.

=head2 reset_connection

    $m->reset_connection(sub { my ($ok, $err) = @_ });

Resets session state (variables, temporary tables, etc.) without
reconnecting. Equivalent to C<COM_RESET_CONNECTION>.

=head2 reset

    $m->reset;

Disconnects and reconnects using the original connection parameters.
Cancels all pending operations.

=head2 finish

    $m->finish;

Disconnects from the server. Cancels all pending operations, invoking
their callbacks with an error.

=head2 escape

    my $escaped = $m->escape($string);

Escapes a string for safe use in SQL, respecting the connection's
character set.

=head2 skip_pending

    $m->skip_pending;

Cancels all pending and in-flight operations, invoking their callbacks
with C<(undef, "skipped")>. If an operation is in progress or pipeline
results are pending, the connection is closed (use C<reset> to
reconnect).

=head1 ACCESSORS

=over 4

=item is_connected

Returns true if connected to the server.

=item error_message

Last error message, or C<undef>.

=item error_number

Last error number (0 if no error).

=item sqlstate

SQLSTATE code (5-character string) for the last error.

=item insert_id

auto_increment value from the last insert.

=item warning_count

Number of warnings from the last query.

=item info

Additional info about the last query (e.g., rows matched for update),
or C<undef>.

=item server_version

Server version as an integer (e.g., 110206 for 11.2.6).

=item server_info

Server version string.

=item thread_id

Connection thread ID.

=item host_info

String describing connection type and host.

=item character_set_name

Current character set name.

=item socket

File descriptor of the connection socket.

=item pending_count

Number of pending operations (queued + in-flight).

=back

=head1 CLASS METHODS

=over 4

=item lib_version

    EV::MariaDB->lib_version;

Client library version as an integer.

=item lib_info

    EV::MariaDB->lib_info;

Client library version string.

=back

=head1 ALIASES

    q          -> query
    prep       -> prepare
    reconnect  -> reset
    disconnect -> finish
    errstr     -> error_message
    errno      -> error_number

=head1 PIPELINING

When multiple queries are submitted before the event loop processes I/O,
EV::MariaDB pipelines them: all queries are sent to the server before
reading any results. This reduces round-trip overhead and can achieve
2-3x higher throughput than sequential execution.

    # all 100 queries are pipelined
    for (1..100) {
        $m->q("select $_", sub { ... });
    }

The maximum pipeline depth is 64 queries. Additional queries are buffered
and sent as earlier results are received.

=head1 SEE ALSO

L<EV>, L<DBD::MariaDB>, L<AnyEvent::MySQL>

=head1 AUTHOR

Yury Kotlyarov

=head1 LICENSE

This library is free software; you can redistribute it and/or modify it
under the same terms as Perl itself.

=cut
